<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check My IP & Speed Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --primary: #1e40af;
      --primary-light: #60a5fa;
      --accent: #2563eb;
      --text: #1f2937;
      --text-light: #6b7280;
      --bg-start: #f0f9ff;
      --bg-end: #dbeafe;
      --card-bg: rgba(255, 255, 255, 0.9);
      --download-color: #2563eb;
      --upload-color: #10b981;
      --ping-color: #8b5cf6;
      --gauge-bg: #e5e7eb;
      --wave-svg-download-1: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%232563eb' fill-opacity='0.1' d='M0,224L60,213.3C120,203,240,181,360,181.3C480,181,600,203,720,197.3C840,192,960,160,1080,154.7C1200,149,1320,171,1380,181.3L1440,192L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
      --wave-svg-download-2: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%232563eb' fill-opacity='0.05' d='M0,192L48,208C96,224,192,256,288,245.3C384,235,480,181,576,165.3C672,149,768,171,864,176C960,181,1056,171,1152,176C1248,181,1344,203,1392,213.3L1440,224L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
      --wave-svg-upload-1: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%2310b981' fill-opacity='0.1' d='M0,224L60,213.3C120,203,240,181,360,181.3C480,181,600,203,720,197.3C840,192,960,160,1080,154.7C1200,149,1320,171,1380,181.3L1440,192L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
      --wave-svg-upload-2: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%2310b981' fill-opacity='0.05' d='M0,192L48,208C96,224,192,256,288,245.3C384,235,480,181,576,165.3C672,149,768,171,864,176C960,181,1056,171,1152,176C1248,181,1344,203,1392,213.3L1440,224L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
      --wave-svg-ping-1: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%238b5cf6' fill-opacity='0.1' d='M0,224L60,213.3C120,203,240,181,360,181.3C480,181,600,203,720,197.3C840,192,960,160,1080,154.7C1200,149,1320,171,1380,181.3L1440,192L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
      --wave-svg-ping-2: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%238b5cf6' fill-opacity='0.05' d='M0,192L48,208C96,224,192,256,288,245.3C384,235,480,181,576,165.3C672,149,768,171,864,176C960,181,1056,171,1152,176C1248,181,1344,203,1392,213.3L1440,224L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, var(--bg-start), var(--bg-end));
      color: var(--text);
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
      overflow-y: auto;
    }

    .bg-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 50% 50%, rgba(30, 64, 175, 0.2) 0%, transparent 50%);
      z-index: -2;
    }

    .container {
      max-width: 1000px;
      width: 90%;
      margin: 2rem auto;
      padding: 2rem;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .container:hover {
      transform: translateY(-4px);
    }

    h1 {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 2.8rem;
      color: var(--primary);
      text-align: center;
      margin-bottom: 0.5rem;
      animation: slideIn 0.8s ease-out;
    }

    .subtitle {
      font-size: 1.1rem;
      color: var(--text-light);
      text-align: center;
      margin-bottom: 1.5rem;
      animation: slideIn 0.8s ease-out 0.2s;
      opacity: 0;
      animation-fill-mode: forwards;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-title {
      font-family: 'Poppins', sans-serif;
      font-size: 1.6rem;
      color: var(--accent);
      margin: 2rem 0 1rem;
      text-align: center;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
      animation: slideIn 0.8s ease-out 0.4s;
      opacity: 0;
      animation-fill-mode: forwards;
    }

    .stat-card {
      background: #ffffff;
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .stat-card i {
      color: var(--primary);
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
    }

    .stat-title {
      font-size: 0.85rem;
      color: var(--text-light);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-value {
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--text);
      margin-top: 0.3rem;
      word-break: break-all;
    }

    .ip-card {
      grid-column: span 2;
      min-width: 300px;
    }

    #map {
      height: 320px;
      border-radius: 10px;
      margin: 2rem 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      animation: slideIn 0.8s ease-out 0.6s;
      opacity: 0;
      animation-fill-mode: forwards;
    }

    .speed-test-section {
      margin: 2rem 0;
      text-align: center;
    }

    .speed-test-card {
      background: #ffffff;
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      margin: 1.5rem auto;
      max-width: 600px;
      animation: slideIn 0.8s ease-out 0.8s;
      opacity: 0;
      animation-fill-mode: forwards;
    }

    .speed-test-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .gauges-container {
      display: flex;
      justify-content: space-around;
      width: 100%;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .gauge-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 33%;
      min-width: 150px;
      padding: 1rem;
      position: relative;
    }

    .gauge-title {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }

    .gauge-result {
      font-size: 2rem;
      font-weight: 700;
      margin-top: 0.5rem;
      font-family: 'Poppins', sans-serif;
      display: flex;
      align-items: baseline;
      justify-content: center;
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .gauge-result-unit {
      font-size: 1rem;
      margin-left: 0.2rem;
      color: var(--text-light);
    }

    .gauge-canvas-container {
      position: relative;
      height: 140px;
      width: 140px;
    }

    .gauge-value-display {
      position: absolute;
      top: 60%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text);
      transition: all 0.3s ease;
    }

    .speed-comparison {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin-top: 2rem;
      margin-bottom: 1rem;
    }

    .comparison-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      background: rgba(37, 99, 235, 0.05);
      min-width: 120px;
    }

    .comparison-title {
      font-size: 0.8rem;
      color: var(--text-light);
    }

    .comparison-value {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text);
    }

    .progress-bar-container {
      width: 100%;
      height: 8px;
      background-color: var(--gauge-bg);
      border-radius: 4px;
      margin: 1.5rem 0;
      overflow: hidden;
      position: relative;
    }

    .progress-bar {
      height: 100%;
      width: 0;
      border-radius: 4px;
      transition: width 0.3s ease-in-out;
      position: relative;
      overflow: hidden;
      background: linear-gradient(90deg, rgba(37, 99, 235, 0.8), rgba(37, 99, 235, 1));
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        90deg,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.3) 50%,
        rgba(255, 255, 255, 0) 100%
      );
      animation: shimmer 2s infinite;
      transform: translateX(-100%);
    }

    @keyframes shimmer {
      100% {
        transform: translateX(100%);
      }
    }

    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin: 2rem 0;
      animation: slideIn 0.8s ease-out 1s;
      opacity: 0;
      animation-fill-mode: forwards;
    }

    .action-button-top {
      display: flex;
      justify-content: center;
      margin-bottom: 1.5rem;
      animation: slideIn 0.8s ease-out 0.3s;
      opacity: 0;
      animation-fill-mode: forwards;
    }

    .action-button {
      background: var(--accent);
      color: white;
      padding: 0.7rem 2rem;
      font-size: 1rem;
      font-weight: 500;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      border: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .action-button:hover {
      background: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    .action-button:disabled {
      background: #a1a1aa;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .error-message {
      color: #dc2626;
      font-size: 0.9rem;
      text-align: center;
      margin: 1rem 0;
      display: none;
    }

    .loading {
      font-size: 0.9rem;
      color: var(--text-light);
      margin: 1rem 0;
      text-align: center;
      display: none;
    }

    .status-indicator {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-top: 0.5rem;
      transition: opacity 0.3s ease;
    }

    .pulse {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #2563eb;
      margin-right: 5px;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      50% {
        transform: scale(1.2);
        opacity: 1;
      }
      100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
    }

    .spark {
      position: absolute;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      pointer-events: none;
      opacity: 0;
    }

    @keyframes spark {
      0% {
        opacity: 1;
        transform: translate(0, 0) scale(0);
      }
      50% {
        opacity: 1;
        transform: translate(var(--tx), var(--ty)) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(calc(var(--tx) * 2), calc(var(--ty) * 2)) scale(0);
      }
    }

    .test-stage {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin: 1rem 0;
      padding: 0.8rem 1.5rem;
      border-radius: 20px;
      background: rgba(37, 99, 235, 0.1);
      font-weight: 500;
      color: var(--primary);
      transform: scale(0);
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .test-stage.active {
      transform: scale(1);
    }

    .wave-container {
      position: absolute;
      bottom: -3px;
      left: 0;
      width: 100%;
      height: 40px;
      overflow: hidden;
      z-index: -1;
    }

    .wave {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 200%;
      height: 100%;
      animation: wave 20s linear infinite;
      transform-origin: center bottom;
    }

    .wave.download:nth-child(1) {
      background: var(--wave-svg-download-1);
    }

    .wave.download:nth-child(2) {
      background: var(--wave-svg-download-2);
      animation: wave 15s linear reverse infinite;
      opacity: 0.7;
    }

    .wave.upload:nth-child(1) {
      background: var(--wave-svg-upload-1);
    }

    .wave.upload:nth-child(2) {
      background: var(--wave-svg-upload-2);
      animation: wave 15s linear reverse infinite;
      opacity: 0.7;
    }

    .wave.ping:nth-child(1) {
      background: var(--wave-svg-ping-1);
    }

    .wave.ping:nth-child(2) {
      background: var(--wave-svg-ping-2);
      animation: wave 15s linear reverse infinite;
      opacity: 0.7;
    }

    @keyframes wave {
      0% {
        transform: translateX(0) scaleY(1);
      }
      50% {
        transform: translateX(-25%) scaleY(0.8);
      }
      100% {
        transform: translateX(-50%) scaleY(1);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 1.5rem;
        margin: 1rem auto;
      }

      h1 {
        font-size: 2.3rem;
      }

      .subtitle {
        font-size: 1rem;
      }

      .section-title {
        font-size: 1.4rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .ip-card {
        grid-column: auto;
        min-width: auto;
      }

      .stat-card {
        padding: 1.2rem;
      }

      #map {
        height: 280px;
      }

      .speed-test-card {
        padding: 1.2rem;
      }

      .action-buttons {
        flex-direction: column;
        gap: 0.8rem;
      }

      .action-button {
        padding: 0.6rem 1.5rem;
        font-size: 0.9rem;
      }

      .gauge-wrapper {
        width: 50%;
        padding: 0.5rem;
      }

      .gauge-canvas-container {
        height: 120px;
        width: 120px;
      }

      .gauge-value-display {
        font-size: 1rem;
      }
    }

    @media (max-width: 576px) {
      .container {
        padding: 1rem;
      }

      h1 {
        font-size: 1.8rem;
      }

      .subtitle {
        font-size: 0.9rem;
      }

      .section-title {
        font-size: 1.2rem;
      }

      .stat-card {
        padding: 1rem;
      }

      .speed-test-card {
        padding: 1rem;
      }

      #map {
        height: 240px;
      }

      .gauge-wrapper {
        width: 100%;
      }

      .speed-comparison {
        gap: 0.5rem;
      }

      .comparison-item {
        min-width: 110px;
        padding: 0.4rem 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="bg-overlay"></div>

  <main class="container">
    <h1>IP & Speed Test</h1>
    <p class="subtitle">Get detailed insights about your IP and internet speed</p>

    <div class="action-button-top">
      <button class="action-button" onclick="fetchIPData()">
        <i class="fas fa-sync-alt"></i> Refresh IP Info
      </button>
    </div>

    <div class="ip-section">
      <h2 class="section-title">IP Information</h2>
      <p class="loading" id="ip-loading">Fetching IP details...</p>
      <p class="error-message" id="ip-error">Failed to fetch IP data. Please check your connection and try again.</p>
      <div class="stats-grid" id="stats-grid">
        <div class="stat-card ip-card">
          <i class="fas fa-network-wired"></i>
          <div class="stat-title">IP Address</div>
          <div class="stat-value" id="ip-address">Loading...</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-globe"></i>
          <div class="stat-title">Country</div>
          <div class="stat-value" id="country">Loading...</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-city"></i>
          <div class="stat-title">City</div>
          <div class="stat-value" id="city">Loading...</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-map-pin"></i>
          <div class="stat-title">Postal Code</div>
          <div class="stat-value" id="postal">Loading...</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-map-marker-alt"></i>
          <div class="stat-title">Coordinates</div>
          <div class="stat-value" id="coordinates">Loading...</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-server"></i>
          <div class="stat-title">ISP</div>
          <div class="stat-value" id="isp">Loading...</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-building"></i>
          <div class="stat-title">Organization</div>
          <div class="stat-value" id="org">Loading...</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-clock"></i>
          <div class="stat-title">Timezone</div>
          <div class="stat-value" id="timezone">Loading...</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-hashtag"></i>
          <div class="stat-title">ASN</div>
          <div class="stat-value" id="asn">Loading...</div>
        </div>
      </div>
      <div id="map"></div>
    </div>

    <div class="speed-test-section">
      <h2 class="section-title">Internet Speed Test</h2>
      <p class="loading" id="speed-loading">Running speed test...</p>
      <p class="error-message" id="speed-error">Failed to run speed test. Please check your connection and try again.</p>
      
      <div class="speed-test-card" id="speed-test-card">
        <div class="test-stage" id="test-stage">
          <div class="pulse"></div>
          <span id="test-stage-text">Ready to test your connection</span>
        </div>
        
        <div class="progress-bar-container" id="progress-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        
        <div class="speed-test-container">
          <div class="gauges-container">
            <div class="gauge-wrapper">
              <div class="gauge-title">
                <i class="fas fa-arrow-down" style="color: var(--download-color);"></i> Download
              </div>
              <div class="gauge-canvas-container">
                <canvas id="download-gauge" width="140" height="140"></canvas>
                <div class="gauge-value-display" id="download-gauge-value">0</div>
                <div class="wave-container">
                  <div class="wave download"></div>
                  <div class="wave download"></div>
                </div>
              </div>
              <div class="gauge-result" id="download-speed">0<span class="gauge-result-unit">Mbps</span></div>
            </div>
            
            <div class="gauge-wrapper">
              <div class="gauge-title">
                <i class="fas fa-arrow-up" style="color: var(--upload-color);"></i> Upload
              </div>
              <div class="gauge-canvas-container">
                <canvas id="upload-gauge" width="140" height="140"></canvas>
                <div class="gauge-value-display" id="upload-gauge-value">0</div>
                <div class="wave-container">
                  <div class="wave upload"></div>
                  <div class="wave upload"></div>
                </div>
              </div>
              <div class="gauge-result" id="upload-speed">0<span class="gauge-result-unit">Mbps</span></div>
            </div>
            
            <div class="gauge-wrapper">
              <div class="gauge-title">
                <i class="fas fa-stopwatch" style="color: var(--ping-color);"></i> Ping
              </div>
              <div class="gauge-canvas-container">
                <canvas id="ping-gauge" width="140" height="140"></canvas>
                <div class="gauge-value-display" id="ping-gauge-value">0</div>
                <div class="wave-container">
                  <div class="wave ping"></div>
                  <div class="wave ping"></div>
                </div>
              </div>
              <div class="gauge-result" id="ping-speed">0<span class="gauge-result-unit">ms</span></div>
            </div>
          </div>
          
          <div class="speed-comparison">
            <div class="comparison-item">
              <div class="comparison-title">Streaming HD</div>
              <div class="comparison-value" id="streaming-quality">N/A</div>
            </div>
            <div class="comparison-item">
              <div class="comparison-title">Video Calls</div>
              <div class="comparison-value" id="video-call-quality">N/A</div>
            </div>
            <div class="comparison-item">
              <div class="comparison-title">Gaming</div>
              <div class="comparison-value" id="gaming-quality">N/A</div>
            </div>
          </div>
          
          <div class="status-indicator" id="status-text">Ready to test your connection speed</div>
        </div>
      </div>
    </div>

    <div class="action-buttons">
      <button class="action-button" onclick="runSpeedTest()" id="speed-test-button">
        <i class="fas fa-tachometer-alt"></i> Run Speed Test
      </button>
    </div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map;
    let marker;
    let downloadGauge, uploadGauge, pingGauge;
    let animationFrameId;
    let currentTestStage = 'idle';
    let testProgress = 0;

    function initMap(lat = 0, lng = 0) {
      try {
        if (map) {
          map.remove();
        }
        map = L.map('map').setView([lat, lng], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        marker = L.marker([lat, lng]).addTo(map);
        console.log('Map initialized successfully at:', lat, lng);
      } catch (error) {
        console.error('Failed to initialize map:', error);
      }
    }

    async function fetchWithTimeout(url, options = {}, timeout = 10000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        const response = await fetch(url, { ...options, signal: controller.signal });
        clearTimeout(id);
        return response;
      } catch (error) {
        clearTimeout(id);
        throw error;
      }
    }

    async function fetchIPData() {
      const ipLoading = document.getElementById('ip-loading');
      const ipError = document.getElementById('ip-error');
      const statsGrid = document.getElementById('stats-grid');
      ipLoading.style.display = 'block';
      ipError.style.display = 'none';
      statsGrid.style.opacity = '0.5';

      try {
        let data;
        try {
          console.log('Attempting to fetch IP data from primary API...');
          const response = await fetchWithTimeout('https://ipapi.co/json/');
          data = await response.json();
          console.log('Primary API success:', data);
        } catch (error) {
          console.warn('Primary API failed, trying fallback:', error);
          const response = await fetchWithTimeout('https://freeipapi.com/api/json');
          data = await response.json();
          data = {
            ip: data.ipAddress || 'N/A',
            country_name: data.countryName || 'N/A',
            country_code: data.countryCode || 'N/A',
            city: data.cityName || 'N/A',
            postal: data.zipCode || 'N/A',
            latitude: data.latitude || 0,
            longitude: data.longitude || 0,
            isp: data.isp || 'N/A',
            org: data.isp || 'N/A',
            timezone: data.timeZone || 'N/A',
            asn: 'N/A'
          };
          console.log('Fallback API success:', data);
        }

        document.getElementById('ip-address').textContent = data.ip;
        document.getElementById('country').textContent = `${data.country_name} (${data.country_code})`;
        document.getElementById('city').textContent = data.city;
        document.getElementById('postal').textContent = data.postal;
        document.getElementById('coordinates').textContent = `${data.latitude}, ${data.longitude}`;
        document.getElementById('isp').textContent = data.isp;
        document.getElementById('org').textContent = data.org;
        document.getElementById('timezone').textContent = data.timezone;
        document.getElementById('asn').textContent = data.asn;

        const lat = parseFloat(data.latitude) || 0;
        const lng = parseFloat(data.longitude) || 0;
        initMap(lat, lng);
        if (marker) {
          marker.setLatLng([lat, lng]);
          marker.bindPopup(`Location: ${data.city || 'Unknown'}, ${data.country_name || 'Unknown'}`).openPopup();
        }
      } catch (error) {
        console.error('Error fetching IP data:', error);
        ipError.style.display = 'block';
        ['ip-address', 'country', 'city', 'postal', 'coordinates', 'isp', 'org', 'timezone', 'asn'].forEach(id => {
          document.getElementById(id).textContent = 'Error';
        });
        initMap(0, 0);
      } finally {
        ipLoading.style.display = 'none';
        statsGrid.style.opacity = '1';
      }
    }

    function createSparks(x, y, count = 10, color = '#2563eb') {
      try {
        const container = document.querySelector('.speed-test-container');
        if (!container) {
          console.error('Speed test container not found for sparks');
          return;
        }
        for (let i = 0; i < count; i++) {
          const spark = document.createElement('div');
          spark.classList.add('spark');
          spark.style.left = `${x}px`;
          spark.style.top = `${y}px`;
          spark.style.backgroundColor = color;

          const angle = Math.random() * Math.PI * 2;
          const distance = 20 + Math.random() * 80;
          const tx = Math.cos(angle) * distance;
          const ty = Math.sin(angle) * distance;

          spark.style.setProperty('--tx', `${tx}px`);
          spark.style.setProperty('--ty', `${ty}px`);

          const duration = 0.5 + Math.random() * 1;
          spark.style.animation = `spark ${duration}s ease-out forwards`;

          container.appendChild(spark);
          setTimeout(() => spark.remove(), duration * 1000);
        }
      } catch (error) {
        console.error('Error creating sparks:', error);
      }
    }

    function initGauges() {
      try {
        const downloadCanvas = document.getElementById('download-gauge');
        const uploadCanvas = document.getElementById('upload-gauge');
        const pingCanvas = document.getElementById('ping-gauge');

        if (downloadCanvas && downloadCanvas.getContext) {
          downloadGauge = downloadCanvas.getContext('2d');
          drawGauge(downloadGauge, 0, 100, 'var(--download-color)');
        } else {
          console.error('Download gauge canvas not found or context unavailable');
        }

        if (uploadCanvas && uploadCanvas.getContext) {
          uploadGauge = uploadCanvas.getContext('2d');
          drawGauge(uploadGauge, 0, 100, 'var(--upload-color)');
        } else {
          console.error('Upload gauge canvas not found or context unavailable');
        }

        if (pingCanvas && pingCanvas.getContext) {
          pingGauge = pingCanvas.getContext('2d');
          drawGauge(pingGauge, 0, 200, 'var(--ping-color)');
        } else {
          console.error('Ping gauge canvas not found or context unavailable');
        }
      } catch (error) {
        console.error('Error initializing gauges:', error);
      }
    }

    function drawGauge(ctx, value, maxValue, color) {
      if (!ctx) {
        console.error('Canvas context not provided for drawGauge');
        return;
      }

      try {
        const canvas = ctx.canvas;
        const width = canvas.width;
        const height = canvas.height;
        const radius = Math.min(width, height) / 2 * 0.85;
        const centerX = width / 2;
        const centerY = height / 2;
        const startAngle = Math.PI * 0.75;
        const endAngle = Math.PI * 2.25;
        const totalAngle = endAngle - startAngle;

        const percentage = Math.min(value / maxValue, 1);
        const currentAngle = startAngle + (totalAngle * percentage);

        ctx.clearRect(0, 0, width, height);

        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, startAngle, endAngle);
        ctx.lineWidth = 10;
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'var(--gauge-bg)';
        ctx.stroke();

        if (percentage > 0) {
          const gradient = ctx.createLinearGradient(0, 0, width, 0);
          gradient.addColorStop(0, color);
          gradient.addColorStop(1, adjustColor(color, 30));

          ctx.beginPath();
          ctx.arc(centerX, centerY, radius, startAngle, currentAngle);
          ctx.lineWidth = 10;
          ctx.lineCap = 'round';
          ctx.strokeStyle = gradient;
          ctx.stroke();
        }

        for (let i = 0; i <= 10; i++) {
          const tickAngle = startAngle + (totalAngle * (i / 10));
          const tickLength = i % 5 === 0 ? 10 : 5;
          const innerRadius = radius - 15;
          const outerRadius = innerRadius - tickLength;

          ctx.beginPath();
          ctx.moveTo(
            centerX + innerRadius * Math.cos(tickAngle),
            centerY + innerRadius * Math.sin(tickAngle)
          );
          ctx.lineTo(
            centerX + outerRadius * Math.cos(tickAngle),
            centerY + outerRadius * Math.sin(tickAngle)
          );
          ctx.lineWidth = i % 5 === 0 ? 2 : 1;
          ctx.strokeStyle = '#9ca3af';
          ctx.stroke();
        }

        ctx.beginPath();
        ctx.arc(centerX, centerY, 5, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.fill();
      } catch (error) {
        console.error('Error drawing gauge:', error);
      }
    }

    function adjustColor(color, amount) {
      try {
        return '#' + color.replace(/^#/, '').replace(/../g, color =>
          ('0' + Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).slice(-2)
        );
      } catch (error) {
        console.error('Error adjusting color:', error);
        return color;
      }
    }

    function animateGauges() {
      if (currentTestStage === 'complete' || currentTestStage === 'error') {
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
        }
        return;
      }

      try {
        const downloadValue = Math.random() * 30 + Math.sin(Date.now() / 200) * 10;
        const uploadValue = Math.random() * 10 + Math.sin(Date.now() / 300) * 5;
        const pingValue = Math.random() * 50 + Math.sin(Date.now() / 100) * 20;

        if (downloadGauge) {
          drawGauge(downloadGauge, downloadValue, 100, 'var(--download-color)');
          document.getElementById('download-gauge-value').textContent = Math.round(downloadValue);
        }
        if (uploadGauge) {
          drawGauge(uploadGauge, uploadValue, 100, 'var(--upload-color)');
          document.getElementById('upload-gauge-value').textContent = Math.round(uploadValue);
        }
        if (pingGauge) {
          drawGauge(pingGauge, pingValue, 200, 'var(--ping-color)');
          document.getElementById('ping-gauge-value').textContent = Math.round(pingValue);
        }

        animationFrameId = requestAnimationFrame(animateGauges);
      } catch (error) {
        console.error('Error in animateGauges:', error);
        cancelAnimationFrame(animationFrameId);
      }
    }

    function countUp(element, target, duration, unit = 'Mbps', decimals = 2) {
      try {
        if (target === 0) {
          element.innerHTML = `0<span class="gauge-result-unit">${unit}</span>`;
          return;
        }

        let start = 0;
        const stepTime = 20;
        const steps = duration / stepTime;
        const increment = target / steps;

        element.style.transform = 'scale(0.5)';
        element.style.opacity = '0';

        setTimeout(() => {
          element.style.transform = 'scale(1)';
          element.style.opacity = '1';

          const interval = setInterval(() => {
            start += increment;
            if (start >= target) {
              element.innerHTML = `${target.toFixed(decimals)}<span class="gauge-result-unit">${unit}</span>`;
              clearInterval(interval);
              element.style.transform = 'scale(1.1)';
              setTimeout(() => {
                element.style.transform = 'scale(1)';
              }, 100);
            } else {
              element.innerHTML = `${start.toFixed(decimals)}<span class="gauge-result-unit">${unit}</span>`;
            }
          }, stepTime);
        }, 300);
      } catch (error) {
        console.error('Error in countUp:', error);
        element.innerHTML = `0<span class="gauge-result-unit">${unit}</span>`;
      }
    }

    function setTestStage(stage, progress = 0) {
      try {
        const testStageElement = document.getElementById('test-stage');
        const testStageText = document.getElementById('test-stage-text');
        const progressBar = document.getElementById('progress-bar');
        const statusText = document.getElementById('status-text');

        currentTestStage = stage;
        testProgress = progress;

        progressBar.style.width = `${progress}%`;

        switch (stage) {
          case 'idle':
            testStageText.textContent = 'Ready to test your connection';
            testStageElement.style.background = 'rgba(37, 99, 235, 0.1)';
            testStageElement.classList.remove('active');
            statusText.textContent = 'Press "Run Speed Test" to begin';
            break;
          case 'preparing':
            testStageText.textContent = 'Preparing test environment';
            testStageElement.style.background = 'rgba(37, 99, 235, 0.1)';
            testStageElement.classList.add('active');
            statusText.textContent = 'Setting up connection parameters...';
            break;
          case 'ping':
            testStageText.textContent = 'Measuring ping';
            testStageElement.style.background = 'rgba(139, 92, 246, 0.1)';
            testStageElement.classList.add('active');
            statusText.textContent = 'Checking server response time...';
            break;
          case 'download':
            testStageText.textContent = 'Testing download speed';
            testStageElement.style.background = 'rgba(37, 99, 235, 0.1)';
            testStageElement.classList.add('active');
            statusText.textContent = 'Downloading test data...';
            break;
          case 'upload':
            testStageText.textContent = 'Testing upload speed';
            testStageElement.style.background = 'rgba(16, 185, 129, 0.1)';
            testStageElement.classList.add('active');
            statusText.textContent = 'Uploading test data...';
            break;
          case 'analyzing':
            testStageText.textContent = 'Analyzing results';
            testStageElement.style.background = 'rgba(37, 99, 235, 0.1)';
            testStageElement.classList.add('active');
            statusText.textContent = 'Processing performance metrics...';
            break;
          case 'complete':
            testStageText.textContent = 'Test completed';
            testStageElement.style.background = 'rgba(16, 185, 129, 0.1)';
            testStageElement.classList.add('active');
            statusText.textContent = 'Your speed test is complete!';
            break;
          case 'error':
            testStageText.textContent = 'Test failed';
            testStageElement.style.background = 'rgba(220, 38, 38, 0.1)';
            testStageElement.classList.add('active');
            statusText.textContent = 'There was an error running the speed test. Please try again.';
            break;
        }
      } catch (error) {
        console.error('Error setting test stage:', error);
      }
    }

    function setComparisonResults(downloadSpeed, pingSpeed) {
      try {
        const streamingEl = document.getElementById('streaming-quality');
        if (downloadSpeed >= 25) {
          streamingEl.textContent = '4K Excellent';
          streamingEl.style.color = '#10b981';
        } else if (downloadSpeed >= 15) {
          streamingEl.textContent = 'HD Excellent';
          streamingEl.style.color = '#10b981';
        } else if (downloadSpeed >= 5) {
          streamingEl.textContent = 'HD Good';
          streamingEl.style.color = '#2563eb';
        } else if (downloadSpeed >= 3) {
          streamingEl.textContent = 'SD Good';
          streamingEl.style.color = '#2563eb';
        } else {
          streamingEl.textContent = 'Poor';
          streamingEl.style.color = '#dc2626';
        }

        const videoCallEl = document.getElementById('video-call-quality');
        if (downloadSpeed >= 5 && pingSpeed <= 50) {
          videoCallEl.textContent = 'Excellent';
          videoCallEl.style.color = '#10b981';
        } else if (downloadSpeed >= 2 && pingSpeed <= 100) {
          videoCallEl.textContent = 'Good';
          videoCallEl.style.color = '#2563eb';
        } else if (downloadSpeed >= 1 && pingSpeed <= 150) {
          videoCallEl.textContent = 'Fair';
          videoCallEl.style.color = '#f59e0b';
        } else {
          videoCallEl.textContent = 'Poor';
          videoCallEl.style.color = '#dc2626';
        }

        const gamingEl = document.getElementById('gaming-quality');
        if (pingSpeed <= 20) {
          gamingEl.textContent = 'Excellent';
          gamingEl.style.color = '#10b981';
        } else if (pingSpeed <= 50) {
          gamingEl.textContent = 'Good';
          gamingEl.style.color = '#2563eb';
        } else if (pingSpeed <= 100) {
          gamingEl.textContent = 'Fair';
          gamingEl.style.color = '#f59e0b';
        } else {
          gamingEl.textContent = 'Poor';
          gamingEl.style.color = '#dc2626';
        }
      } catch (error) {
        console.error('Error setting comparison results:', error);
      }
    }

    async function runSpeedTest() {
      const speedLoading = document.getElementById('speed-loading');
      const speedError = document.getElementById('speed-error');
      const speedTestCard = document.getElementById('speed-test-card');
      const speedTestButton = document.getElementById('speed-test-button');
      const speedContainer = document.querySelector('.speed-test-container');

      try {
        // Reset UI
        document.getElementById('download-speed').innerHTML = '0<span class="gauge-result-unit">Mbps</span>';
        document.getElementById('upload-speed').innerHTML = '0<span class="gauge-result-unit">Mbps</span>';
        document.getElementById('ping-speed').innerHTML = '0<span class="gauge-result-unit">ms</span>';

        document.getElementById('download-gauge-value').textContent = '0';
        document.getElementById('upload-gauge-value').textContent = '0';
        document.getElementById('ping-gauge-value').textContent = '0';

        if (downloadGauge) drawGauge(downloadGauge, 0, 100, 'var(--download-color)');
        if (uploadGauge) drawGauge(uploadGauge, 0, 100, 'var(--upload-color)');
        if (pingGauge) drawGauge(pingGauge, 0, 200, 'var(--ping-color)');

        const comparisons = ['streaming-quality', 'video-call-quality', 'gaming-quality'];
        comparisons.forEach(id => {
          document.getElementById(id).textContent = 'N/A';
          document.getElementById(id).style.color = 'var(--text)';
        });

        speedLoading.style.display = 'block';
        speedError.style.display = 'none';
        speedTestCard.style.opacity = '0.9';
        speedTestButton.disabled = true;

        // Preparing
        setTestStage('preparing', 5);
        const rect = speedContainer.getBoundingClientRect();
        createSparks(rect.width / 2, rect.height / 2, 15);
        await new Promise(resolve => setTimeout(resolve, 800));

        // Ping Test
        setTestStage('ping', 15);
        animateGauges();

        let pingTime = 0;
        try {
          console.log('Running ping test...');
          const pingStartTime = performance.now();
          await fetchWithTimeout('https://www.cloudflare.com/cdn-cgi/trace', {}, 5000);
          const pingEndTime = performance.now();
          pingTime = Math.min(Math.round(pingEndTime - pingStartTime), 200);
          console.log('Ping test completed:', pingTime, 'ms');
        } catch (error) {
          console.warn('Ping test failed:', error);
          pingTime = 100; // Fallback value
        }

        await new Promise(resolve => setTimeout(resolve, 800));
        cancelAnimationFrame(animationFrameId);

        if (pingGauge) {
          drawGauge(pingGauge, pingTime, 200, 'var(--ping-color)');
          document.getElementById('ping-gauge-value').textContent = pingTime;
          countUp(document.getElementById('ping-speed'), pingTime, 600, 'ms', 0);
        }

        const pingGaugeEl = document.querySelector('#ping-gauge');
        if (pingGaugeEl && speedContainer) {
          createSparks(
            pingGaugeEl.getBoundingClientRect().left + 70 - rect.left,
            pingGaugeEl.getBoundingClientRect().top + 70 - rect.top,
            8,
            'var(--ping-color)'
          );
        }

        // Download Test
        setTestStage('download', 40);
        animateGauges();

        let downloadMbps = 0;
        try {
          console.log('Running download test...');
          const startTime = performance.now();
          const response = await fetchWithTimeout('https://speed.cloudflare.com/__down?bytes=5000000', {}, 10000);
          const blob = await response.blob();
          const endTime = performance.now();

          const duration = (endTime - startTime) / 1000;
          const fileSize = 5 * 8; // 5MB in Mbits
          downloadMbps = (fileSize / duration).toFixed(2);
          console.log('Download test completed:', downloadMbps, 'Mbps');
        } catch (error) {
          console.warn('Download test failed:', error);
          downloadMbps = 10; // Fallback value
        }

        cancelAnimationFrame(animationFrameId);

        const downloadResult = Math.min(parseFloat(downloadMbps), 100);
        if (downloadGauge) {
          drawGauge(downloadGauge, downloadResult, 100, 'var(--download-color)');
          document.getElementById('download-gauge-value').textContent = downloadResult.toFixed(0);
          countUp(document.getElementById('download-speed'), downloadResult, 800);
        }

        const downloadGaugeEl = document.querySelector('#download-gauge');
        if (downloadGaugeEl && speedContainer) {
          createSparks(
            downloadGaugeEl.getBoundingClientRect().left + 70 - rect.left,
            downloadGaugeEl.getBoundingClientRect().top + 70 - rect.top,
            12,
            'var(--download-color)'
          );
        }

        // Upload Test
        await new Promise(resolve => setTimeout(resolve, 800));
        setTestStage('upload', 70);
        animateGauges();

        let uploadMbps = 0;
        try {
          console.log('Running upload test...');
          const uploadStartTime = performance.now();
          const uploadData = new Blob([new ArrayBuffer(1 * 1024 * 1024)]); // 1MB
          const formData = new FormData();
          formData.append('file', uploadData);

          await fetchWithTimeout('https://httpbin.org/post', {
            method: 'POST',
            body: formData
          }, 10000);
          const uploadEndTime = performance.now();

          const uploadDuration = (uploadEndTime - uploadStartTime) / 1000;
          const uploadFileSize = 1 * 8; // 1MB in Mbits
          uploadMbps = (uploadFileSize / uploadDuration).toFixed(2);
          console.log('Upload test completed:', uploadMbps, 'Mbps');
        } catch (error) {
          console.warn('Upload test failed:', error);
          uploadMbps = 5; // Fallback value
        }

        cancelAnimationFrame(animationFrameId);

        const uploadResult = Math.min(parseFloat(uploadMbps), 100);
        if (uploadGauge) {
          drawGauge(uploadGauge, uploadResult, 100, 'var(--upload-color)');
          document.getElementById('upload-gauge-value').textContent = uploadResult.toFixed(0);
          countUp(document.getElementById('upload-speed'), uploadResult, 800);
        }

        const uploadGaugeEl = document.querySelector('#upload-gauge');
        if (uploadGaugeEl && speedContainer) {
          createSparks(
            uploadGaugeEl.getBoundingClientRect().left + 70 - rect.left,
            uploadGaugeEl.getBoundingClientRect().top + 70 - rect.top,
            12,
            'var(--upload-color)'
          );
        }

        // Analyzing and Complete
        setTestStage('analyzing', 90);
        await new Promise(resolve => setTimeout(resolve, 800));

        setComparisonResults(downloadResult, pingTime);
        setTestStage('complete', 100);

        if (speedContainer) {
          const finalRect = speedContainer.getBoundingClientRect();
          createSparks(finalRect.width / 2, finalRect.height / 2, 30, '#10b981');
        }
      } catch (error) {
        console.error('Critical error in speed test:', error);
        speedError.style.display = 'block';
        setTestStage('error', 100);
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        if (downloadGauge) drawGauge(downloadGauge, 0, 100, 'var(--download-color)');
        if (uploadGauge) drawGauge(uploadGauge, 0, 100, 'var(--upload-color)');
        if (pingGauge) drawGauge(pingGauge, 0, 200, 'var(--ping-color)');
      } finally {
        speedLoading.style.display = 'none';
        speedTestCard.style.opacity = '1';
        speedTestButton.disabled = false;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('Document loaded, initializing...');
      initMap();
      initGauges();
      fetchIPData();
      setTestStage('idle');
    });
  </script>
</body>
</html>